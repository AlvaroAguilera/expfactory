---
layout: default
title: Generate your Experiment Container
pdf: true
permalink: /generate
toc: true
---

# Generate your Experiment Container
The generation of a container comes down to adding the experiments to a build file called a Singularity Recipe. In these sections, we will provide instructions for a [quick start](#quick-start) using a pre-generated container, and a more [detailed start](#detailed-start) where you can fine tune your experiments, database, and other details of your deployment.

## Quick Start
**Under development**
We provide an example container that you can deploy to test out Expfactory. It includes three experiments:

 - adaptive-n-back
 - test-task
 - tower-of-london

and is configured to use a "filesystem" database, meaning results are written to a folder that is mounted from the container on the host in `json`, organized by a study identifier. To get started quickly, we will do the following steps:

 1. install Singularity
 2. pull the experiment container
 3. start an instance
 4. use it!


**Install Singularity**
Instructions are provided on the [Singularity main site](https://singularityware.github.io/install-linux).

**Pull the Container**
The container is build and provided for you on Singularity Hub. To pull the latest version:

```
singularity pull --name `expfactory.simg` shub://expfactory/expfactory
```
What experiments are installed?

```
singularity apps expfactory.simg
adaptive-n-back
test-task
tower-of-london
```

And you can also inspect, and ask the image for help. Try these commands on your local machine:

```
singularity help expfactory.simg
singularity inspect expfactory.simg

{
    "org.label-schema.usage.singularity.deffile.bootstrap": "docker",
    "org.label-schema.usage.singularity.deffile": "Singularity",
    "org.label-schema.usage": "/.singularity.d/runscript.help",
    "org.label-schema.schema-version": "1.0",
    "org.label-schema.usage.singularity.deffile.from": "ubuntu:14.04",
    "org.label-schema.build-date": "2017-11-06T20:42:28+00:00",
    "org.label-schema.usage.singularity.runscript.help": "/.singularity.d/runscript.help",
    "org.label-schema.usage.singularity.version": "2.4-feature-squashbuild-secbuild.g818b648",
    "org.label-schema.build-size": "545MB"
}
```
Importantly, any labels that you add to the `%labels` section of a custom recipe will appear here. More on that later.


**Create an Instance**
You next want to start an instance of your container, which will carry it's own namespace and run the web server. Importantly, you need to choose a folder on your local machine to put experiment data (`/tmp/data`), and bind it to the data folder in the instance (`/scif/data`). You will also want to name your instance, we are calling it `web1`

```
mkdir -p /tmp/data
singularity instance.start --bind /tmp/data:/scif/data expfactory.simg web1
singularity instance.list
DAEMON NAME      PID      CONTAINER IMAGE
web1             22045    /home/vanessa/Desktop/expfactory.simg
```

When you turn the instance off, the data will persits at `/scif/data`. This is the "filesystem" database type.

## Detailed Start


### Write your recipe
A Singularity Recipe is a file that details how you want your container to build. In our case, we want to give instructions about which experiments to install. You can get a recipe in multiple ways!

1. Use the [example recipe provided](https://github.com/expfactory/expfactory/blob/master/Singularity)

```
wget https://raw.githubusercontent.com/expfactory/expfactory/master/Singularity
```

2. Use our [Recipe generator](https://www.github.com/expfactory/experiments/) to select experiments from the table, and generate a custom recipe. The table will also let you search and preview experiments in your browser.

3. Browse our [recipes generated by tag](https://www.github.com/expfactory/experiments/recipes) from the library.

You should have a build recipe `Singularity` in your present working directory. If you are using the example recipe, by default we will install three experiments, adaptive-n-back, test-task, and tower-of-london. The experiments each have their own repository maintained under the Organization Expfactory Experiments ([https://www.github.com/expfactory-experiments](https://www.github.com/expfactory-experiments)). If you are interested in all the experiments available to you, you can look at the library manifest:

```
curl https://expfactory.github.io/experiments/library.json

[
    {
        "name": "adaptive-n-back",
        "github": "https://www.github.com/expfactory-experiments/adaptive-n-back",
        "preview": "https://expfactory-experiments.github.io/adaptive-n-back",
        "maintainer": "@vsoch",
        "tags": ["jspsych","experiment"]
  },

    {
        "name": "test-task",
        "github": "https://www.github.com/expfactory-experiments/test-task",
        "preview": "https://expfactory-experiments.github.io/test-task",
        "maintainer": "@vsoch",
        "tags": ["test","jspsych","experiment"]
  },

    {
        "name": "tower-of-london",
        "github": "https://www.github.com/expfactory-experiments/tower-of-london",
        "preview": "https://expfactory-experiments.github.io/tower-of-london",
        "maintainer": "@vsoch",
        "tags": ["jspsych","experiment"]
  }
]

```
or just the names

```
curl https://expfactory.github.io/experiments/library.json | grep name
        "name": "adaptive-n-back",
        "name": "test-task",
        "name": "tower-of-london",
```

If you look inside the recipe, you will see an "app" section for each experiment. All it does is clone the repository content, and the experiment is installed by the expfactory software:

```
%appinstall test-task
    cd .. && expfactory install -f -b /opt/expfactory/expfactory https://github.com/expfactory-experiments/test-task
```

We are installing each experiment as a [Standard Container Integration Format (SCI-F)](https://containers-ftw.github.io/SCI-F/) app. The high level idea is that it gives easy accessibility to multiple different internal modules in our container. In our case, an internal module is an experiment. 

### Database

**filesystem**
The default (simplest) method for a database is flat files, meaning that results are written to a mapped folder on the local machine, and each participant has their own results folder. This option is provided as many labs are accustomed to providing a battery locally, and want to save output directly to the filesystem without having any expertise with setting up a database.

**MySQL/Postgres/Mongo/Other**
For labs that wish to deploy the container on a server, you are encouraged to use a more substantial database. We haven't yet developed this, and if you are interested, please [file an issue](https://github.com/expfactory/expfactory).

In the future when you have the option to set up a custom database (other than filesystem) you will do so via a set of environment variables in the Singularity Recipe. Here is what the default looks like:

```
EXPFACTORY_DATA=/scif/data
EXPFACTORY_DATABASE=filesystem 
```

### Configure your Battery
The Experiment Factory will generate a new unique ID for each participant with some study idenitifier prefix. The default is `expfactory`, meaning that my participants will be given identifiers `expfactory/0` through `expfactory/n`, and for a filesystem database, it will produce output files according to that schema:

```
 /scif/data/
      expfactory/
           0/
            tower-of-london.json
            test-task.json
            adaptive-n-back.json
```

If you want to change the study identifier, just customize the variable under the `%environment` section:

```
%environment
    EXPFACTORY_STUDY_ID=expfactory
    export EXPFACTORY_STUDY_ID
```

In the future, our [online recipe generator](https://expfactory.github.io/experiments/generate) will make it easy to specify all of these variables. We will add these later after getting [feedback from users like you](https://www.github.com/expfactory/expfactory/issues). Let's move on the building your battery.

### Define Custom Metadata
If you remember from the quick start above, we can inspect an image!

```
$ singularity inspect expfactory.simg
{
    "org.label-schema.usage.singularity.deffile.bootstrap": "docker",
    "org.label-schema.usage.singularity.deffile": "Singularity",
    "org.label-schema.usage": "/.singularity.d/runscript.help",
    "org.label-schema.schema-version": "1.0",
    "org.label-schema.usage.singularity.deffile.from": "ubuntu:14.04",
    "org.label-schema.build-date": "2017-11-06T20:42:28+00:00",
    "org.label-schema.usage.singularity.runscript.help": "/.singularity.d/runscript.help",
    "org.label-schema.usage.singularity.version": "2.4-feature-squashbuild-secbuild.g818b648",
    "org.label-schema.build-size": "545MB"
}
```

If you want any labels programmatically accessible here, add them to the containers global label section:

```
%labels
    Maintainer Vanessasaur
    Version 1.0.0
```

You can also add them specific to a particular experiment:

```
%applabels test-task
   variable value
```

We have plans to expose experiment-specific variables in this way, but @vsoch hasn't implemented it yet! Please send [feedback](https://www.github.com/expfactory/expfactory/issues) about your use case to help.


### Build the Battery Container
Let's build the image. Note that this is a squashfs image, which is a read online, immutable file system. We are only writing by way of mounting to the host. It's a reproducibility badass.

```
sudo singularity build expfactory.simg Singularity
```

Where expfactory.simg is referring to your image, and `.simg` is in reference to the squashfs filesystem. Let's break down the above. We are asking the singularity command line software to `build` an image **from** the recipe file `Singularity`.

Once building is done, we can see what experiments are installed:

```
singularity apps expfactory
adaptive-n-back
tower-of-london
test-task
```

You can also ask for help, and as we saw above, inspect:

```
singularity help expfactory.simg
singularity inspect expfactory.simg
```



<div>
    <a href="/expfactory/"><button class="previous-button btn btn-primary"><i class="fa fa-chevron-left"></i> </button></a>
    <a href="/expfactory/usage.html"><button class="next-button btn btn-primary"><i class="fa fa-chevron-right"></i> </button></a>
</div><br>
